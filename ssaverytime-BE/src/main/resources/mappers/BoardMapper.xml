<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssaverytime.server.mapper.BoardMapper">

    <!-- 게시글 목록 조회 -->
    <select id="selectBoardList" resultType="com.ssaverytime.server.domain.dto.board.BoardResponseDto">
        SELECT 
            b.BOARD_ID,
            b.TITLE,
            b.SUMMARY,
            b.CREATED_AT,
            b.UPDATED_AT,
            b.VISIBLE,
            b.USER_ID AS userSeq,
            CASE WHEN b.USER_ID IS NULL THEN 'anonymous' ELSE u.BOJ_ID END AS bojId,
            CASE WHEN b.USER_ID IS NULL THEN '익명' ELSE u.NAME END AS userName,
            CASE WHEN b.USER_ID IS NULL THEN b.AUTHOR_TIER ELSE IFNULL(u.BAEKJOON, 'Unrated') END AS userTier,
            (SELECT COUNT(*) FROM LIKES l WHERE l.BOARD_ID = b.BOARD_ID) AS likeCount,
            (SELECT COUNT(*) FROM COMMENT c WHERE c.BOARD_ID = b.BOARD_ID AND c.VISIBLE = '1' AND c.VALID = '1') AS commentCount,
            <choose>
                <when test="currentUserSeq != null">
                    (SELECT COUNT(*) > 0 FROM LIKES l WHERE l.BOARD_ID = b.BOARD_ID AND l.USER_ID = #{currentUserSeq}) AS isLiked,
                    (SELECT COUNT(*) > 0 FROM SCRAP s WHERE s.BOARD_ID = b.BOARD_ID AND s.USER_ID = #{currentUserSeq}) AS isScrapped
                </when>
                <otherwise>
                    FALSE AS isLiked,
                    FALSE AS isScrapped
                </otherwise>
            </choose>
        FROM BOARD b
        LEFT JOIN USER u ON b.USER_ID = u.USER_ID
        WHERE b.VISIBLE IN ('1', '0') AND b.VALID = '1'
        <if test="keyword != null and keyword != ''">
            AND (b.TITLE LIKE CONCAT('%', #{keyword}, '%') OR b.BODY LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        ORDER BY
        <choose>
            <when test="sort == 'likes'">
                likeCount DESC, b.CREATED_AT DESC
            </when>
            <when test="sort == 'comments'">
                commentCount DESC, b.CREATED_AT DESC
            </when>
            <otherwise>
                b.CREATED_AT DESC
            </otherwise>
        </choose>
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 게시글 상세 조회 -->
    <select id="selectBoardDetail" resultType="com.ssaverytime.server.domain.dto.board.BoardResponseDto">
        SELECT 
            b.BOARD_ID,
            b.TITLE,
            b.BODY,
            b.SUMMARY,
            b.CREATED_AT,
            b.UPDATED_AT,
            b.VISIBLE,
            b.USER_ID AS userSeq,
            CASE WHEN b.USER_ID IS NULL THEN 'anonymous' ELSE u.BOJ_ID END AS bojId,
            CASE WHEN b.USER_ID IS NULL THEN '익명' ELSE u.NAME END AS userName,
            CASE WHEN b.USER_ID IS NULL THEN b.AUTHOR_TIER ELSE IFNULL(u.BAEKJOON, 'Unrated') END AS userTier,
            (SELECT COUNT(*) FROM LIKES l WHERE l.BOARD_ID = b.BOARD_ID) AS likeCount,
            (SELECT COUNT(*) FROM COMMENT c WHERE c.BOARD_ID = b.BOARD_ID AND c.VISIBLE = '1' AND c.VALID = '1') AS commentCount,
            <choose>
                <when test="currentUserSeq != null">
                    (SELECT COUNT(*) > 0 FROM LIKES l WHERE l.BOARD_ID = b.BOARD_ID AND l.USER_ID = #{currentUserSeq}) AS isLiked,
                    (SELECT COUNT(*) > 0 FROM SCRAP s WHERE s.BOARD_ID = b.BOARD_ID AND s.USER_ID = #{currentUserSeq}) AS isScrapped
                </when>
                <otherwise>
                    FALSE AS isLiked,
                    FALSE AS isScrapped
                </otherwise>
            </choose>
        FROM BOARD b
        LEFT JOIN USER u ON b.USER_ID = u.USER_ID
        WHERE b.BOARD_ID = #{boardId} AND b.VALID = '1'
    </select>

    <!-- 게시글 작성 -->
    <insert id="insertBoard" parameterType="com.ssaverytime.server.domain.dto.board.BoardRequestDto" useGeneratedKeys="true" keyProperty="boardId">
        INSERT INTO BOARD (USER_ID, TITLE, BODY, SUMMARY, VISIBLE, AUTHOR_TIER)
        VALUES (#{userSeq}, #{title}, #{body}, #{summary}, #{visible}, #{authorTier})
    </insert>

    <!-- 게시글 수정 -->
    <update id="updateBoard" parameterType="com.ssaverytime.server.domain.dto.board.BoardRequestDto">
        UPDATE BOARD
        SET TITLE = #{title},
            BODY = #{body},
            SUMMARY = #{summary},
            UPDATED_AT = NOW()
        WHERE BOARD_ID = #{boardId}
    </update>

    <!-- 게시글 삭제 (Soft Delete) -->
    <update id="deleteBoard">
        UPDATE BOARD SET VALID = '0' WHERE BOARD_ID = #{boardId}
    </update>

    <!-- 게시글 숨김 처리 (관리자 또는 본인 삭제 시 사용 가능) -->
    <update id="updateBoardVisibility">
        UPDATE BOARD SET VISIBLE = #{visible} WHERE BOARD_ID = #{boardId}
    </update>

    <!-- 좋아요 -->
    <insert id="insertLike">
        INSERT INTO LIKES (BOARD_ID, USER_ID) VALUES (#{boardId}, #{userSeq})
    </insert>

    <delete id="deleteLike">
        DELETE FROM LIKES WHERE BOARD_ID = #{boardId} AND USER_ID = #{userSeq}
    </delete>

    <select id="checkLike" resultType="int">
        SELECT COUNT(*) FROM LIKES WHERE BOARD_ID = #{boardId} AND USER_ID = #{userSeq}
    </select>

    <!-- 스크랩 -->
    <insert id="insertScrap">
        INSERT INTO SCRAP (BOARD_ID, USER_ID) VALUES (#{boardId}, #{userSeq})
    </insert>

    <delete id="deleteScrap">
        DELETE FROM SCRAP WHERE BOARD_ID = #{boardId} AND USER_ID = #{userSeq}
    </delete>

    <select id="checkScrap" resultType="int">
        SELECT COUNT(*) FROM SCRAP WHERE BOARD_ID = #{boardId} AND USER_ID = #{userSeq}
    </select>

</mapper>
